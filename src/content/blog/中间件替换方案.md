---
author: cobo
pubDatetime: 2023-01-30T15:57:52.737Z
title: 中间件替换方案
featured: false
draft: false
tags:
 - robot
description: this is auto generate
---
# Springboot使用loader.path加载其他jar

>  [[编程/java/Java]] [[spring]] [[spring boot]]
## Classpath
可以使用`classpath`指定类加载路径
``sh
java -cp.;lib/x.jar Text
jva -cp lib/x.jar -jar app.jar
``
## Loader.path
springboot程序大多是达成jar包，可以使用loader.path 指定类加载路径加载其他jar,loader.path生效有条件

|命令|MANIFEST.MF main-class|loader.path生效|打包配置|
|-----|--------------------|--------------|--------|
|java -Dloader.path=./lib -jar app.jar|JarLauncher|X|默认配置|
|java -Dloader.path=./lib -Dloader.main=kl.kcsp.StartApplication -jar app.jar|PropertiesLauncher|ok|默认配置|

配置Main-class
--
```sh
bootJar {
    manifest {
        attributes 'Main-Class': 'org.springframework.boot.loader.PropertiesLauncher'
    }
}
```
maven修改springboot打包插件如下
```xml
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>org.springframework.boot.loader.PropertiesLauncher</mainClass>
                    <layout>ZIP</layout>
                    <includeSystemScope>true</includeSystemScope>
                </configuration>
            </plugin>
```

## LaunchedURLClassLoader
无论启动类是 JarLauncher 或者 PropertiesLauncher，loader.path 引入的 jar 和 Spring Boot 中 lib/*.jar 都是使用类加载器 org.springframework.boot.loader.LaunchedURLClassLoader 进行加载，也即是说他们使用的是同一个类加载器。
> PropertiesLauncher比jarLauncher 启动慢

## 问题
通过`loader.path`加载得spring component。初始化时间比autocomponent得时间慢。所以不能识别到外置得tomcatstarter。解决方案：
1. spring去掉 `EmbeddedWebServerFactoryCustomizerAutoConfiguration`
```java
@SpringBootApplication(exclude = {QuartzAutoConfiguration.class, EmbeddedWebServerFactoryCustomizerAutoConfiguration.class})
```

2. 自己实现一个相同`Configuration` order优先级调低
```java
@Configuration
@ConditionalOnWebApplication
@Order
@EnableConfigurationProperties({ServerProperties.class})
public class KcspEmbeddedWebServerConfig extends EmbeddedWebServerFactoryCustomizerAutoConfiguration {

}

```
此时load.path 在，webServerComponent 初始化时就能扫描到。容器替换成功，为了开发方便，内置了`jetty`容器，所以还需要把spring 配置打开。允许重复装载。（此处存疑？当有多个web servlet开启，spring默认初始化规则，需要在看下）

```yaml
spring
  main:
    allow-bean-definition-overriding: true
```

[spring loader过程解析](https://zhuanlan.zhihu.com/p/129746554)